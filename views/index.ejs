<%- include('partials/head') %>

<body>
    <a href="/presentation" class="presentation-link">
        Prezent√°cia
    </a>
    <h1>üéµ Ovl√°danie piesn√≠</h1>
    <label>Hƒæada≈• podƒæa n√°zvu alebo ƒç√≠sla</label>
    <input type="text" id="hladat" placeholder="napr. Kristus alebo 123" oninput="filtrovatPiesne()">

    <label>Piese≈à</label>
    <select id="song-select" onchange="updateStrofy()"></select>

    <label>Strofa</label>
    <select id="strofa-select"></select>

    <button onclick="zobraz()">Zobrazi≈•</button>
    <button onclick="predchadzajuca()">‚¨Ö Predch√°dzaj√∫ca strofa</button>
    <button onclick="dalsia()">ƒéal≈°ia strofa ‚û°</button>
    <button onclick="skry()">Skry≈•</button>

    <script>
        var piesne = [];

        function setView(skryta = null) {
            var currentPiesenId = $('#song-select').val();
            var currentIndex = $('#strofa-select').val();

            var data = {
                piesenId: currentPiesenId,
                strofaIndex: currentIndex
            }

            if (skryta !== null) {
                data.skryta = skryta;
            }

            $.ajax({
                url: '/set-view',
                method: 'POST',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    console.log('Stav aktualizovan√Ω:', response);
                },
                error: function(xhr, status, error) {
                    console.error('Chyba pri aktualiz√°cii stavu:', error);
                }
            });
        }

        function zobraz() {
            setView(false);
        }

        function skry() {
            setView(true);
        }

        function dalsia() {
            var select = $('#strofa-select');
            var currentPiesenId = $('#song-select').val();
            var currentIndex = select.prop('selectedIndex');
            if (currentIndex < select.children().length - 1) {
                select.prop('selectedIndex', currentIndex + 1);
            }
            setView();
        }

        function predchadzajuca() {
            var select = $('#strofa-select');
            var currentPiesenId = $('#song-select').val();
            var currentIndex = select.prop('selectedIndex');
            if (currentIndex > 0) {
                select.prop('selectedIndex', currentIndex - 1);
            }
            setView();
        }

        function updateStrofy() {
            var select = $('#song-select');
            var selectedId = select.val();
            var strofaSelect = $('#strofa-select');
            strofaSelect.empty(); // Vyma≈æe existuj√∫ce mo≈ænosti

            if (selectedId) {
                var selectedPiesen = piesne.find(function(piesen) {
                    return piesen.id.toString() === selectedId;
                });

                if (selectedPiesen && selectedPiesen.strofy) {
                    selectedPiesen.strofy.forEach(function(strofa, index) {
                        var option = $('<option></option>');
                        option.val(index);
                        option.text(`${index + 1}: ${strofa}`);
                        strofaSelect.append(option);
                    });

                    if (strofaSelect.children().length > 0) {
                        strofaSelect.val(0); // Predvolen√° hodnota prvej strofky
                    }
                }
            }
        }

        function filtrovatPiesne() {
            var filter = $('#hladat').val().toLowerCase();
            var filteredPiesne = piesne.filter(function(piesen) {
                return piesen.nazov.toLowerCase().includes(filter) || piesen.id.toString().includes(filter);
            });
            naplnPiesne(filteredPiesne);
        }

        function naplnPiesne(piesne) {
            var select = $('#song-select');
            select.empty(); // Vyma≈æe existuj√∫ce mo≈ænosti

            piesne.forEach(function(piesen) {
                var option = $('<option></option>');
                option.val(piesen.id);
                option.text(`${piesen.nazov} (${piesen.id})`);
                select.append(option);
            });

            if (piesne.length == 1) {
                select.val(piesne[0].id);
            }

            updateStrofy(); // Aktualizuje stƒ∫pec so strofami
        }

        $(function() {
            $.ajax({
                url: '/piesne_kontroller.json',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    piesne = data;
                    console.log('Piesne naƒç√≠tan√©:', piesne);
                    naplnPiesne(piesne);
                },
                error: function(xhr, status, error) {
                    console.error('Chyba pri naƒç√≠tan√≠ piesn√≠:', error);
                }
            });

        });
    </script>
</body>