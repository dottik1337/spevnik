<%- include('partials/head') %>

<body>
    <div class="view-container">
        <div class="nav">
            <a href="/presentation" class="presentation-link">
                Prezent√°cia
            </a>
            <a href="/settings">Nastavenia</a>
        </div>
        <h1>üéµ Ovl√°danie piesn√≠</h1>
        <label>Hƒæada≈• podƒæa n√°zvu alebo ƒç√≠sla</label>
        <input type="text" id="hladat" placeholder="napr. Kristus alebo 123" oninput="filtrovatPiesne()">
        
        <label>Piese≈à</label>
        <select id="song-select" onchange="updateStrofy()"></select>
        
        <label>Strofa</label>
        <select id="strofa-select"></select>
        <div class="button-grid">
            <div class="button-row">
                <button onclick="zobraz()" style="background-color: green;">Zobrazi≈•</button>
                <button onclick="zobrazId()" style="background-color: blue;">N√°hlad</button>
            </div>
            <div class="button-row">
                <button onclick="skry()" style="background-color: red;">Skry≈•</button>
            </div>
            <div class="button-row">
                <button onclick="predchadzajuca()">‚¨Ö Predch√°dzaj√∫ca strofa</button>
                <button onclick="dalsia()">ƒéal≈°ia strofa ‚û°</button>
            </div>
        </div>
    </div>

    <script>
        var piesne;
        var piesne_array;

        function setView(skryta = null, showingName = null) {
            var currentPiesenId = $('#song-select').val();
            var currentIndex = $('#strofa-select').val();

            var data = {
                piesenId: currentPiesenId,
                strofaIndex: currentIndex
            }

            if (skryta !== null) {
                data.skryta = skryta;
            }

            if (showingName !== null) {
                data.showingName = showingName;
            }

            $.ajax({
                url: '/set-view',
                method: 'POST',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    console.log('Stav aktualizovan√Ω:', response);
                },
                error: function(xhr, status, error) {
                    console.error('Chyba pri aktualiz√°cii stavu:', error);
                }
            });
        }

        function zobrazId(){
            setView(null, true);
        }

        function zobraz() {
            setView(false, true);
        }

        function skry() {
            setView(true, false);
        }

        function dalsia() {
            var select = $('#strofa-select');
            var currentPiesenId = $('#song-select').val();
            var currentIndex = select.prop('selectedIndex');
            if (currentIndex < select.children().length - 1) {
                select.prop('selectedIndex', currentIndex + 1);
            }
            setView();
        }

        function predchadzajuca() {
            var select = $('#strofa-select');
            var currentPiesenId = $('#song-select').val();
            var currentIndex = select.prop('selectedIndex');
            if (currentIndex > 0) {
                select.prop('selectedIndex', currentIndex - 1);
            }
            setView();
        }

        function updateStrofy() {
            var select = $('#song-select');
            var selectedId = select.val();
            var strofaSelect = $('#strofa-select');
            strofaSelect.empty(); // Vyma≈æe existuj√∫ce mo≈ænosti

            if (selectedId) {
                var selectedPiesen = piesne[selectedId];

                if (selectedPiesen && selectedPiesen.strofy) {
                    selectedPiesen.strofy.forEach(function(strofa, index) {
                        var option = $('<option></option>');
                        option.val(index);
                        option.text(`${index + 1}: ${strofa}`);
                        strofaSelect.append(option);
                    });

                    if (strofaSelect.children().length > 0) {
                        strofaSelect.val(0); // Predvolen√° hodnota prvej strofky
                    }
                }
            }
        }

        function filtrovatPiesne() {
            var filter = $('#hladat').val().toLowerCase();
            var filteredPiesne = piesne_array.filter(function(piesen) {
                return piesen.nazov.toLowerCase().includes(filter) || piesen.id.toString().includes(filter);
            });
            naplnPiesne(filteredPiesne);
        }

        function naplnPiesne(piesne) { //piesne je list
            var select = $('#song-select');
            select.empty(); // Vyma≈æe existuj√∫ce mo≈ænosti

            piesne.forEach(function(piesen) {
                var option = $('<option></option>');
                option.val(piesen.id);
                option.text(`${piesen.nazov} (${piesen.id})`);
                select.append(option);
            });

            if (piesne.length == 1) {
                select.val(piesne[0].id);
            }

            updateStrofy(); // Aktualizuje stƒ∫pec so strofami
        }

        $(function() {
            $.ajax({
                url: '/piesne.json',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    piesne = data;
                    piesne_array = Object.values(piesne)
                    console.log('Piesne naƒç√≠tan√©:', piesne);
                    naplnPiesne(piesne_array);
                },
                error: function(xhr, status, error) {
                    console.error('Chyba pri naƒç√≠tan√≠ piesn√≠:', error);
                }
            });

        });
    </script>
</body>